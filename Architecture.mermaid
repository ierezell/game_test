%%{init: {
  'theme': 'dark',
  'themeVariables': {
    'primaryColor': '#4a90e2',
    'primaryTextColor': '#ffffff',
    'primaryBorderColor': '#ffffff',
    'lineColor': '#ffffff',
    'secondaryColor': '#2d3748',
    'tertiaryColor': '#1a202c',
    'background': '#1a202c',
    'mainBkg': '#2d3748',
    'secondBkg': '#4a5568',
    'tertiaryBkg': '#718096'
  }
}}%%
flowchart TB
    Start([ğŸ® Game Launch]) --> Launcher{{"ğŸš€ Launcher<br/>Parse CLI Args"}}
    Launcher --> |"--server"| ServerMode["ğŸ–¥ï¸ Server Mode"]
    Launcher --> |"--client --client_id X"| ClientMode["ğŸ’» Client Mode"]  
    Launcher --> |"--solo"| SoloMode["ğŸ¯ Solo Mode<br/>Combined Client+Server"]
    
    %% Server initialization flow
    ServerMode --> ServerApp["ğŸ“¦ Create Server App"]
    ServerApp --> ServerPlugins["ğŸ”§ Add Server Plugins<br/>â€¢ NetworkPlugin<br/>â€¢ GameplayPlugin<br/>â€¢ SharedPlugin"]
    ServerPlugins --> ServerNetwork["ğŸŒ Initialize Networking<br/>â€¢ Lightyear Server<br/>â€¢ UDP Transport"]
    ServerNetwork --> ServerReady["ğŸ¯ Server Ready<br/>Listening on Port"]
    
    %% Client initialization flow
    ClientMode --> ClientApp["ğŸ“± Create Client App"]
    ClientApp --> ClientPlugins["ğŸ”§ Add Client Plugins<br/>â€¢ RenderPlugin<br/>â€¢ InputPlugin<br/>â€¢ MenuPlugin<br/>â€¢ GameLifecyclePlugin<br/>â€¢ SharedPlugin"]
    ClientPlugins --> ClientNetwork["ğŸŒ Initialize Client Networking<br/>â€¢ Lightyear Client<br/>â€¢ Connection Config"]
    ClientNetwork --> MainMenu["ğŸ“‹ Main Menu State"]
    
    %% Solo mode combines both
    SoloMode --> SoloApp["ğŸ® Create Combined App"]
    SoloApp --> SoloClientPlugins["ğŸ“± Add Client&Server Plugins"]
    SoloClientPlugins --> SoloNetwork["ğŸŒ Initialize Both Networks"]
    SoloNetwork --> SoloAutoConnect["ğŸ¤– Auto-Connect Enabled"]
    SoloAutoConnect --> MainMenu

    %% Game State Flow
    MainMenu --> |"Connect Button<br/>or Auto-Connect"| Connecting["ğŸ”Œ Connecting State"]
    Connecting --> |"Connection Success"| Loading["â³ Loading State"]
    Connecting --> |"Connection Failed"| ConnectionRetry["ğŸ”„ Retry Connection"]
    ConnectionRetry --> Connecting
    Loading --> |"Level + Player Ready"| Spawning["ğŸ—ï¸ Spawning State"]
    Spawning --> Playing["ğŸ® Playing State"]
    Playing --> |"Disconnect/Exit"| MainMenu

    %% Server-side entity management
    ServerReady --> ServerWaitClients["ğŸ‘¥ Wait for Clients"]
    ServerWaitClients --> |"Client Connects"| ServerSpawnPlayer["ğŸ‘¤ Spawn Player Entity<br/>â€¢ Assign PlayerId<br/>â€¢ Create Physics Body"]
    ServerSpawnPlayer --> ServerSpawnLevel["ğŸ¢ Spawn Level Entities<br/>â€¢ Scene Objects<br/>â€¢ Navigation Mesh"]
    ServerSpawnLevel --> ServerSpawnBots["ğŸ¤– Spawn AI Bots<br/>â€¢ Behavior State Machines<br/>â€¢ Pathfinding Agents"]
    ServerSpawnBots --> ServerSpawnEnemies["ğŸ‘¹ Spawn Enemies<br/>â€¢ AI Controllers<br/>â€¢ Health Systems"]
    ServerSpawnEnemies --> ServerReplication["ğŸ”„ Start Entity Replication"]

    %% Shared systems (subgraph)
    subgraph SharedSystems ["ğŸŒ Shared Systems (Client + Server)"]
        Protocol["ğŸ“‹ Protocol Definition<br/>â€¢ Component Registration<br/>â€¢ Input Actions<br/>â€¢ Replication Rules"]
        GameStateSystem["ğŸ® Game State Management<br/>â€¢ MainMenu â†’ Connecting â†’ Loading â†’ Spawning â†’ Playing"]
        InputSystem["âŒ¨ï¸ Input Systems<br/>â€¢ Player Movement<br/>â€¢ Look Controls<br/>â€¢ Jump & Shoot"]
        StaminaSystem["ğŸ’¨ Stamina System<br/>â€¢ Exhaustion Levels<br/>â€¢ Movement Speed Penalties"]
        HealthSystem["â¤ï¸ Health System<br/>â€¢ Damage Calculation<br/>â€¢ Respawn Logic"]
        NavigationSystem["ğŸ—ºï¸ Navigation System<br/>â€¢ Pathfinding<br/>â€¢ AI Movement"]
    end

    %% AI and Machine Learning
    subgraph AIMLSystems ["ğŸ§  AI & Machine Learning"]
        BotAI["ğŸ¤– Bot AI<br/>â€¢ Idle/Searching/Engaging<br/>â€¢ Target Selection<br/>â€¢ Combat Behavior"]
        EnemyAI["ğŸ‘¹ Enemy AI<br/>â€¢ Patrol Patterns<br/>â€¢ Chase Logic<br/>â€¢ Attack Behaviors"]
        RLTraining["ğŸ“ Reinforcement Learning<br/>â€¢ Q-Network Training<br/>â€¢ Action Prediction<br/>â€¢ Exploration vs Exploitation"]
        LLMIntegration["ğŸ’¬ LLM Integration<br/>â€¢ Dynamic Behavior<br/>â€¢ Adaptive Strategies"]
    end

    %% Game loop details
    Playing --> GameLoop["ğŸ”„ Game Loop"]
    GameLoop --> InputUpdate["âŒ¨ï¸ Process Input<br/>â€¢ Movement & Look<br/>â€¢ Actions (Jump/Shoot)"]
    InputUpdate --> StaminaUpdate["ï¿½ Update Stamina<br/>â€¢ Drain on Sprint<br/>â€¢ Regeneration"]
    StaminaUpdate --> AIUpdate["ğŸ¤– Update AI<br/>â€¢ Bot Decisions<br/>â€¢ Enemy Behaviors"]
    AIUpdate --> PhysicsUpdate["âš™ï¸ Physics Update<br/>â€¢ Avian3D Integration<br/>â€¢ Collision Detection"]
    PhysicsUpdate --> NetworkSync["ğŸ“¡ Network Sync<br/>â€¢ Entity Replication<br/>â€¢ Input Prediction"]
    NetworkSync --> RenderFrame["ğŸ¨ Render Frame<br/>â€¢ 3D Scene<br/>â€¢ UI Elements"]
    RenderFrame --> GameLoop
      
    %% Networking layer (subgraph)
    subgraph NetworkingLayer ["ğŸ“¡ Networking (Lightyear 0.25.3)"]
        NetReplication["ğŸ”„ Entity Replication<br/>â€¢ Position/Rotation<br/>â€¢ Player States<br/>â€¢ Health/Stamina<br/>â€¢ Scene Objects"]
        InputSync["âŒ¨ï¸ Input Synchronization<br/>â€¢ Client Prediction<br/>â€¢ Server Reconciliation<br/>â€¢ Lag Compensation"]
        Events["ğŸ“¢ Network Events<br/>â€¢ Player Join/Leave<br/>â€¢ Combat Actions<br/>â€¢ State Changes"]
        ClientAuth["ğŸ” Client Authority<br/>â€¢ Input Validation<br/>â€¢ Anti-Cheat Measures"]
    end

    %% Connect shared systems to flows
    SharedSystems -.-> ServerPlugins
    SharedSystems -.-> ClientPlugins
    SharedSystems -.-> SoloClientPlugins
    
    %% Connect AI systems
    AIMLSystems -.-> ServerSpawnBots
    AIMLSystems -.-> ServerSpawnEnemies
    AIMLSystems -.-> AIUpdate
    
    %% Connect networking to game loop
    NetworkingLayer -.-> NetworkSync
    NetworkingLayer -.-> ServerReplication
    
    %% Styling with improved color scheme
    classDef serverStyle fill:#ff6b6b,stroke:#ffffff,stroke-width:2px,color:#ffffff
    classDef clientStyle fill:#4ecdc4,stroke:#ffffff,stroke-width:2px,color:#ffffff
    classDef soloStyle fill:#ffe66d,stroke:#ffffff,stroke-width:2px,color:#000000
    classDef sharedStyle fill:#95e1d3,stroke:#ffffff,stroke-width:2px,color:#000000
    classDef gameStateStyle fill:#a8e6cf,stroke:#ffffff,stroke-width:2px,color:#000000
    classDef gameLoopStyle fill:#ffd93d,stroke:#ffffff,stroke-width:2px,color:#000000
    classDef aiStyle fill:#dda0dd,stroke:#ffffff,stroke-width:2px,color:#000000
    classDef networkStyle fill:#87ceeb,stroke:#ffffff,stroke-width:2px,color:#000000
    classDef errorStyle fill:#ff8b94,stroke:#ffffff,stroke-width:2px,color:#ffffff
    
    %% Apply server styles
    class ServerMode,ServerApp,ServerPlugins,ServerNetwork,ServerReady,ServerWaitClients,ServerSpawnPlayer,ServerSpawnLevel,ServerSpawnBots,ServerSpawnEnemies,ServerReplication serverStyle
    
    %% Apply client styles
    class ClientMode,ClientApp,ClientPlugins,ClientNetwork,MainMenu,Connecting,Loading,Spawning,Playing clientStyle
    
    %% Apply solo styles  
    class SoloMode,SoloApp,SoloClientPlugins,SoloServerPlugins,SoloNetwork,SoloAutoConnect soloStyle
    
    %% Apply shared system styles
    class SharedSystems,Protocol,GameStateSystem,InputSystem,StaminaSystem,HealthSystem,NavigationSystem sharedStyle
    
    %% Apply game state styles
    class MainMenu,Connecting,Loading,Spawning,Playing gameStateStyle
    
    %% Apply game loop styles
    class GameLoop,InputUpdate,StaminaUpdate,AIUpdate,PhysicsUpdate,NetworkSync,RenderFrame gameLoopStyle
    
    %% Apply AI/ML styles
    class AIMLSystems,BotAI,EnemyAI,RLTraining,LLMIntegration aiStyle
    
    %% Apply networking styles
    class NetworkingLayer,NetReplication,InputSync,Events,ClientAuth networkStyle
    
    %% Apply error/retry styles
// [MermaidChart: 0f825056-d19f-4496-b51f-60a5c46eb118]
    class ConnectionRetry errorStyle